# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

MessagingSettings is a Spring Boot microservice for managing messaging configurations. It's part of Sundsvall Municipality's microservice ecosystem built on the dept44 framework.

## Build Commands

```bash
# Build and run all tests
mvn verify

# Run only unit tests
mvn test

# Run only integration tests
mvn verify -DskipTests

# Run a single test class
mvn test -Dtest=MessagingSettingsServiceTest

# Run a single test method
mvn test -Dtest=MessagingSettingsServiceTest#fetchMessagingSettings

# Run the application locally
mvn spring-boot:run
```

## Architecture

### Layer Structure

- **api/** - REST controllers and request/response models. Uses `@Validated` for input validation.
- **service/** - Business logic layer. `MessagingSettingsService` orchestrates between database and external integrations.
- **integration/db/** - JPA repository, entities, mappers, and JPA Specifications for dynamic queries.
- **integration/employee/** - Feign client for Employee API (fetches user department info via OAuth2).

### Key Patterns

**Multi-tenancy**: All endpoints are prefixed with `/{municipalityId}`. Settings are scoped to a municipality.

**Key-Value Storage**: `MessagingSettingEntity` stores configuration as a list of key-value pairs (`MessagingSettingValueEmbeddable`) with typed values (STRING, BOOLEAN, etc.).

**Dynamic Filtering**: Uses spring-filter library for query parameter filtering. Filter syntax example: `values.key:'namespace' and values.value:'NS1'`. For multiple key-value conditions, use `exists()`: `exists(values.key:'namespace' and values.value:'NS2') and exists(values.key:'department_name' and values.value:'paratransit')`.

**Hierarchical Resolution**: `fetchMessagingSettingsForUser` resolves settings by checking user's department hierarchy (via Employee API) and returns settings from the first matching organizational level.

### Code Generation

- Employee API models are generated from `src/main/resources/contracts/employee/employee.yaml` into `generated.se.sundsvall.employee` package.
- JPA metamodel classes are generated by hibernate-jpamodelgen for type-safe criteria queries.

## Testing

### Test Types

- **Unit tests** (`src/test/java`): Use Mockito with `@ExtendWith(MockitoExtension.class)`. Profile: `junit`.
- **Integration tests** (`src/integration-test/java`): Extend `AbstractAppTest` from dept44. Use WireMock for external APIs and Testcontainers for MariaDB. Profile: `it`.

### Integration Test Structure

Tests in `apptest/` follow dept44 conventions:
- Test class annotated with `@WireMockAppTestSuite`
- Test data in `src/integration-test/resources/{TestClassName}/__files/{testMethodName}/`
- Request/response JSON files: `request.json`, `response.json`
- WireMock mappings in `mappings/` subdirectory
- Database setup via `@Sql` with scripts in `/db/scripts/`

## Dependencies

- **dept44-starter**: Core framework providing OAuth2, error handling, and common utilities
- **dept44-common-validators**: Validation annotations like `@ValidMunicipalityId`, `@ValidUuid`
- **spring-filter**: Dynamic JPA filtering from query parameters
- **Flyway**: Database migrations (disabled by default, migrations in `src/main/resources/db/migration/`)

## External Integrations

**Employee API**: OAuth2-secured Feign client to fetch employee department information. Configured via `integration.employee.*` properties.
